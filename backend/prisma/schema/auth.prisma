model Session {
    id String @id @default(uuid()) @db.Uuid

    hashedRefreshToken String?   @db.VarChar(255)
    userIp             String    @db.VarChar(45) // IPv6 max length
    expiresAt          DateTime? // Thêm field để track session expiration
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt

    // foreign keys
    userId       String @db.Uuid
    userDeviceId String @db.Uuid

    // relations
    user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    userDevice UserDevice @relation(fields: [userDeviceId], references: [id], onDelete: Cascade)

    @@unique([userId, userDeviceId])
    @@index([userId]) // Index for user lookup
    @@index([userDeviceId]) // Index for device lookup
    @@index([createdAt]) // Index for session expiration queries
    @@index([userId, createdAt]) // Composite index for user's recent sessions
    @@map("sessions")
}

model Code {
    id String @id @default(uuid()) @db.Uuid

    code      String?  @db.VarChar(10)
    type      CodeType
    expiresAt DateTime // Thêm field để track code expiration
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // foreign keys
    userId String? @unique @db.Uuid

    // relations
    user User? @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

    @@unique([userId, type]) // Mỗi user chỉ có 1 code active cho mỗi type
    @@index([userId]) // Index for user lookup
    @@index([expiresAt]) // Index for cleanup expired codes
    @@map("codes")
}

model UserDevice {
    id         String   @id @default(uuid()) @db.Uuid
    deviceName String   @db.VarChar(255)
    deviceType String?  @db.VarChar(50) // iOS, Android, Web, Desktop
    userAgent  String?  @db.Text
    lastUsedAt DateTime @default(now())
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    // foreign keys
    userId String @db.Uuid

    // relations
    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    sessions Session[]

    @@index([userId]) // Index for user lookup
    @@index([lastUsedAt]) // Index for inactive device cleanup
    @@map("user_devices")
}

enum CodeType {
    VERIFY
    RESET_PASSWORD
}
